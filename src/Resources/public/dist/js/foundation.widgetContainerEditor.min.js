"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();!function(e){var t=function(){function t(n,a){_classCallCheck(this,t),this.$element=n,this.options=e.extend({},t.defaults,n.data(),a),this._init(),Foundation.registerPlugin(this,"WidgetContainerEditor")}return _createClass(t,[{key:"_init",value:function(){this.widgetId=this.options.widgetId,this.containerName=this.options.containerName,this.$toolbar=this.$element.find("> [data-container-toolbar]"),e("#content-widgets-reveal").length>0?this.$contentWidgetsReveal=e("#content-widgets-reveal"):(this.$contentWidgetsReveal=e('<div id="content-widgets-reveal" class="reveal content-widgets-reveal" data-reveal>'),e("body").append(this.$contentWidgetsReveal),this.$contentWidgetsReveal.foundation()),this._isMasterContainer()&&(this.$widgets=this.$element.find(".widget"),this.$childContainers=this.$element.find(".widgetcontainer"),this.widgetsMovable=!1,this.$dragged=null,this.$placeholder=e('<div class="widget widget-placeholder">')),this._events()}},{key:"_isMasterContainer",value:function(){return"mastercontainer"===this.options.containerType}},{key:"_events",value:function(){var t=this;this.$toolbar.on("click","[data-new-widget]",this._getWidgetTypes.bind(this)),this._isMasterContainer()&&(this.$element.on("click","[data-toggle-toolbars]",function(e){e.preventDefault(),t.$element.toggleClass("preview")}),this.options.isStandalone&&(this.$toolbar.on("click","[data-save-container]",this._saveContainer.bind(this)),this.$toolbar.on("click","[data-container-versions]",this._getContainerVersions.bind(this))),this.$widgets.on("mouseenter","> [data-widget-toolbar] [data-move-widget]",function(){t.widgetsMovable=!0}),this.$widgets.on("mouseleave","> [data-widget-toolbar] [data-move-widget]",function(){t.widgetsMovable=!1}),this.$widgets.on("dragstart",function(n){if(!t.widgetsMovable)return!1;n.stopPropagation(),t.$dragged=e(n.currentTarget);var a=n.originalEvent.dataTransfer;a.effectAllowed="move"}),this.$widgets.add(this.$childContainers).on("dragenter",function(n){n.stopPropagation();var a=e(n.currentTarget);if(!a.is(t.$dragged)&&!e.contains(t.$dragged,a)){if(a.is(".widgetcontainer"))return a.find("> [data-container-toolbar]").after(t.$dragged),!0;if(a.is(".widget")){if(t.$dragged.index()<a.index())return a.after(t.$dragged),!0;if(t.$dragged.index()>a.index())return a.before(t.$dragged),!0}}}),this.$widgets.on("dragend",function(n){n.stopPropagation();var a=e(n.currentTarget),i=a.parents(".widgetcontainer");t._ajaxGet("/widget/"+a.data("widgetId")+"/move-to/"+i.data("containerName")+"/position/"+(a.index()-1))}))}},{key:"_revealEvents",value:function(){this.$contentWidgetsReveal.off("click","a[data-select-type]").on("click","a[data-select-type]",this._createWidget.bind(this)),this.$contentWidgetsReveal.off("submit","form").on("submit","form",this._submitCreatedWidget.bind(this))}},{key:"_getWidgetTypes",value:function(e){e.preventDefault(),this._ajaxGet("/widget/types")}},{key:"_createWidget",value:function(t){t.preventDefault();var n=e(t.currentTarget).data("selectType");this._ajaxGet("/container/"+this.containerName+"/add-widget/"+n)}},{key:"_submitCreatedWidget",value:function(t){t.preventDefault();var n=e(t.currentTarget);this._ajaxFormSubmit(n)}},{key:"_saveContainer",value:function(e){e.preventDefault(),this._ajaxGet("/container/"+this.containerName+"/save")}},{key:"_getContainerVersions",value:function(e){e.preventDefault(),this._ajaxGet("/container/"+this.containerName+"/versions")}},{key:"_ajaxGet",value:function(t,n){var a=this;void 0===n&&(n={}),e.ajax({type:"get",url:""+this.options.rootPath+t,dataType:"json",data:n,success:function(e){a._ajaxCallback(e)}})}},{key:"_ajaxFormSubmit",value:function(t){var n=this;e.ajax({type:"post",url:t.attr("action"),dataType:"json",data:t.serializeArray(),success:function(e){console.log(e),n._ajaxCallback(e)}})}},{key:"_ajaxCallback",value:function(e){switch(console.log(e.action),e.action){case"open-reveal":this._openReveal(e.html);break;case"display-new-widget":this._displayNewWidget(e.html);break;case"close-reveal":default:this.$contentWidgetsReveal.foundation("close")}e.messages.length>0}},{key:"_openReveal",value:function(e){this.$contentWidgetsReveal.html(e),this.$contentWidgetsReveal.find("> *").foundation(),this.$contentWidgetsReveal.foundation("open"),this._revealEvents()}},{key:"_displayNewWidget",value:function(t){this.$contentWidgetsReveal.foundation("close");var n=e(t);this.$element.append(n),n.foundation()}},{key:"destroy",value:function(){Foundation.unregisterPlugin(this)}}],[{key:"defaults",get:function(){return{containerId:"",containerName:"",containerType:"",isStandalone:!1,rootPath:""}}}]),t}();Foundation.plugin(t,"WidgetContainerEditor")}(jQuery);